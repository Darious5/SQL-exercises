/*crea un procedimiento que guarde todos los clientes 
que sean españoles en una tabla que se llame españa
crea la tabla y si son de madrid pon que son de granada
y actualiza el limite de credito a la mitad*/


	DROP PROCEDURE RACISMO



CREATE proc racismo 
as
	begin
		IF (OBJECT_ID('ESPANA') IS NULL)
			BEGIN
				CREATE TABLE ESPANA(
					CODIGO_CLIENTE INT NOT NULL PRIMARY KEY,
					NOMBRE_CLIENTE VARCHAR(50) NOT NULL,
					CIUDAD VARCHAR(50) NOT NULL,
					LIMITE_CREDITO NUMERIC(15,2),
				)
			END
		INSERT INTO ESPANA 
			SELECT CODIGO_CLIENTE,NOMBRE_CLIENTE,CIUDAD,LIMITE_CREDITO FROM CLIENTE
			WHERE PAIS='SPAIN'
		UPDATE ESPANA
		SET CIUDAD='GRANADA' , LIMITE_CREDITO=LIMITE_CREDITO/2
		WHERE CIUDAD='MADRID'
	end
	BEGIN TRANSACTION
	ROLLBACK TRANSACTION
RACISMO
SELECT * FROM ESPANA


/*AÑADE UNA COLUMNA A LA TABLA CLIENTE QUE SE LLAME DESCUENTO
Y COMPRUEBA QUE POR CADA PEDIDO QUE HAYA HECHO LE AÑADA
UN 1% DE DESCUENTO SI LA FECHA DE ENTREGA DE SU PEDIDO ES MAS
TARDE DE LA ESPERADA SIN EMBARGO SI LA FECHA DE ENTREGA ES ANTERIOR
A LA ESPERADA, RESTALE UN 1% POR PEDIDO*/
ALTER TABLE CLIENTE ADD DESCUENTO INT

CREATE PROC AÑADIR_DESCUENTO
AS
BEGIN
	DECLARE CURS CURSOR FOR 
		SELECT CLIENTE.CODIGO_CLIENTE,CLIENTE.DESCUENTO,PEDIDO.FECHA_ESPERADA,
		PEDIDO.FECHA_ENTREGA
		FROM CLIENTE
		JOIN PEDIDO ON PEDIDO.CODIGO_CLIENTE=CLIENTE.CODIGO_CLIENTE
		
	DECLARE @CODIGO_CLIENTE INT,@DESCUENTO INT,@FECHA_ESPERADA DATE,@FECHA_ENTREGA DATE

	OPEN CURS

	FETCH NEXT FROM CURS INTO @CODIGO_CLIENTE,@DESCUENTO,@FECHA_ESPERADA,@FECHA_ENTREGA
	WHILE(@@FETCH_STATUS=0)
		BEGIN
			IF @FECHA_ENTREGA>@FECHA_ESPERADA
				BEGIN
					UPDATE CLIENTE
					SET DESCUENTO=
					(SELECT COUNT(CODIGO_CLIENTE) FROM PEDIDO
					WHERE ESTADO='ENTREGADO' AND  CODIGO_CLIENTE=@CODIGO_CLIENTE
					GROUP BY CODIGO_CLIENTE )
					WHERE CODIGO_CLIENTE=@CODIGO_CLIENTE
				END
			ELSE IF @FECHA_ENTREGA<@FECHA_ESPERADA
				BEGIN
					UPDATE CLIENTE
					SET DESCUENTO=
					(SELECT COUNT(CODIGO_CLIENTE)*-1 FROM PEDIDO
					WHERE ESTADO='ENTREGADO' AND  CODIGO_CLIENTE=@CODIGO_CLIENTE
					GROUP BY CODIGO_CLIENTE)
					WHERE CODIGO_CLIENTE=@CODIGO_CLIENTE
				END
			FETCH NEXT FROM CURS INTO @CODIGO_CLIENTE,@DESCUENTO,@FECHA_ESPERADA,@FECHA_ENTREGA
		END
END

SELECT * FROM CLIENTE
BEGIN TRANSACTION
ROLLBACK TRANSACTION
AÑADIR_DESCUENTO